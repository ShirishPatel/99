/**
 * Social Likes
 * http://sapegin.github.com/social-likes
 *
 * Sharing buttons for Russian and worldwide social networks.
 *
 * @requires jQuery
 * @author Artem Sapegin
 * @copyright 2014 Artem Sapegin (sapegin.me)
 * @license MIT
 */
(function(n){typeof define=="function"&&define.amd?define(["jquery"],n):n(jQuery)})(function(n,t){"use strict";function h(n,t){this.container=n;this.options=t;this.init()}function c(t,i){this.widget=t;this.options=n.extend({},i);this.detectService();this.service&&this.init()}function y(n){function f(n,t){return t.toUpper()}var r={},u=n.data(),i,t;for(i in u)t=u[i],t==="yes"?t=!0:t==="no"&&(t=!1),r[i.replace(/-(\w)/g,f)]=t;return r}function u(n,t){return l(n,t,encodeURIComponent)}function l(n,t,i){return n.replace(/\{([^\}]+)\}/g,function(n,r){return r in t?i?i(t[r]):t[r]:n})}function e(n,t){var i=a+n;return i+" "+i+"_"+t}function p(t,i){function r(e){e.type==="keydown"&&e.which!==27||n(e.target).closest(t).length||(t.removeClass(s),u.off(f,r),n.isFunction(i)&&i())}var u=n(document),f="click touchstart keydown";u.on(f,r)}function w(n){var t=10;if(document.documentElement.getBoundingClientRect){var r=parseInt(n.css("left"),10),u=parseInt(n.css("top"),10),i=n[0].getBoundingClientRect();i.left<t?n.css("left",t-i.left+r):i.right>window.innerWidth-t&&n.css("left",window.innerWidth-i.right-t+r);i.top<t?n.css("top",t-i.top+u):i.bottom>window.innerHeight-t&&n.css("top",window.innerHeight-i.bottom-t+u)}n.addClass(s)}var i="social-likes",a=i+"__",s=i+"_opened",f=location.protocol==="https:"?"https:":"http:",v=f==="https:",r={facebook:{counterUrl:"https://graph.facebook.com/fql?q=SELECT+total_count+FROM+link_stat+WHERE+url%3D%22{url}%22&callback=?",convertNumber:function(n){return n.data[0].total_count},popupUrl:"https://www.facebook.com/sharer/sharer.php?u={url}",popupWidth:600,popupHeight:500},twitter:{counterUrl:"https://cdn.api.twitter.com/1/urls/count.json?url={url}&callback=?",convertNumber:function(n){return n.count},popupUrl:"https://twitter.com/intent/tweet?url={url}&text={title}",popupWidth:600,popupHeight:450,click:function(){return/[\.\?:\-–—]\s*$/.test(this.options.title)||(this.options.title+=":"),!0}},mailru:{counterUrl:f+"//connect.mail.ru/share_count?url_list={url}&callback=1&func=?",convertNumber:function(n){for(var t in n)if(n.hasOwnProperty(t))return n[t].shares},popupUrl:f+"//connect.mail.ru/share?share_url={url}&title={title}",popupWidth:550,popupHeight:360},vkontakte:{counterUrl:"https://vk.com/share.php?act=count&url={url}&index={index}",counter:function(t,i){var f=r.vkontakte,e;f._||(f._=[],window.VK||(window.VK={}),window.VK.Share={count:function(n,t){f._[n].resolve(t)}});e=f._.length;f._.push(i);n.getScript(u(t,{index:e})).fail(i.reject)},popupUrl:f+"//vk.com/share.php?url={url}&title={title}",popupWidth:550,popupHeight:330},odnoklassniki:{counterUrl:v?t:"http://connect.ok.ru/dk?st.cmd=extLike&ref={url}&uid={index}",counter:function(t,i){var f=r.odnoklassniki,e;f._||(f._=[],window.ODKL||(window.ODKL={}),window.ODKL.updateCount=function(n,t){f._[n].resolve(t)});e=f._.length;f._.push(i);n.getScript(u(t,{index:e})).fail(i.reject)},popupUrl:"http://connect.ok.ru/dk?st.cmd=WidgetSharePreview&service=odnoklassniki&st.shareUrl={url}",popupWidth:550,popupHeight:360},plusone:{counterUrl:v?t:"http://share.yandex.ru/gpp.xml?url={url}",counter:function(t,i){var f=r.plusone;if(f._){i.reject();return}window.services||(window.services={});window.services.gplus={cb:function(n){typeof n=="string"&&(n=n.replace(/\D/g,""));f._.resolve(parseInt(n,10))}};f._=i;n.getScript(u(t)).fail(i.reject)},popupUrl:"https://plus.google.com/share?url={url}",popupWidth:700,popupHeight:500},pinterest:{counterUrl:f+"//api.pinterest.com/v1/urls/count.json?url={url}&callback=?",convertNumber:function(n){return n.count},popupUrl:f+"//pinterest.com/pin/create/button/?url={url}&description={title}",popupWidth:630,popupHeight:270}},o={promises:{},fetch:function(t,i,f){var h;if(o.promises[t]||(o.promises[t]={}),h=o.promises[t],!f.forceUpdate&&h[i])return h[i];var e=n.extend({},r[t],f),s=n.Deferred(),c=e.counterUrl&&u(e.counterUrl,{url:i});return c&&n.isFunction(e.counter)?e.counter(c,s):e.counterUrl?n.getJSON(c).done(function(t){try{var i=t;n.isFunction(e.convertNumber)&&(i=e.convertNumber(t));s.resolve(i)}catch(r){s.reject()}}).fail(s.reject):s.reject(),h[i]=s.promise(),h[i]}};n.fn.socialLikes=function(t){return this.each(function(){var r=n(this),u=r.data(i);u?n.isPlainObject(t)&&u.update(t):(u=new h(r,n.extend({},n.fn.socialLikes.defaults,t,y(r))),r.data(i,u))})};n.fn.socialLikes.defaults={url:window.location.href.replace(window.location.hash,""),title:document.title,counters:!0,zeroes:!1,wait:500,timeout:1e4,popupCheckInterval:500,singleTitle:"Share",initHtml:!0};h.prototype={init:function(){this.container.addClass(i);this.single=this.container.hasClass(i+"_single");this.initUserButtons();this.countersLeft=0;this.number=0;this.container.on("counter."+i,n.proxy(this.updateCounter,this));var t=this.container.children();this.makeSingleButton();this.buttons=[];t.each(n.proxy(function(t,i){var r=new c(n(i),this.options);this.buttons.push(r);r.options.counterUrl&&this.countersLeft++},this));this.options.counters?(this.timer=setTimeout(n.proxy(this.appear,this),this.options.wait),this.timeout=setTimeout(n.proxy(this.ready,this,!0),this.options.timeout)):this.appear()},initUserButtons:function(){!this.userButtonInited&&window.socialLikesButtons&&n.extend(!0,r,socialLikesButtons);this.userButtonInited=!0},makeSingleButton:function(){var t;if(this.single){t=this.container;t.addClass(i+"_vertical");t.wrap(n("<div>",{"class":i+"_single-w"}));t.wrapInner(n("<div>",{"class":i+"__single-container"}));var u=t.parent(),r=n("<div>",{"class":e("widget","single")}),f=n(l('<div class="{buttonCls}"><span class="{iconCls}"><\/span>{title}<\/div>',{buttonCls:e("button","single"),iconCls:e("icon","single"),title:this.options.singleTitle}));r.append(f);u.append(r);r.on("click",function(){var n=i+"__widget_active";return r.toggleClass(n),r.hasClass(n)?(t.css({left:-(t.width()-r.width())/2,top:-t.height()}),w(t),p(t,function(){r.removeClass(n)})):t.removeClass(s),!1});this.widget=r}},update:function(t){if(t.forceUpdate||t.url!==this.options.url){this.number=0;this.countersLeft=this.buttons.length;this.widget&&this.widget.find("."+i+"__counter").remove();n.extend(this.options,t);for(var r=0;r<this.buttons.length;r++)this.buttons[r].update(t)}},updateCounter:function(n,t,i){i&&(this.number+=i,this.single&&this.getCounterElem().text(this.number));this.countersLeft--;this.countersLeft===0&&(this.appear(),this.ready())},appear:function(){this.container.addClass(i+"_visible")},ready:function(n){this.timeout&&clearTimeout(this.timeout);this.container.addClass(i+"_ready");n||this.container.trigger("ready."+i,this.number)},getCounterElem:function(){var t=this.widget.find("."+a+"counter_single");return t.length||(t=n("<span>",{"class":e("counter","single")}),this.widget.append(t)),t}};c.prototype={init:function(){if(this.detectParams(),this.options.initHtml)this.initHtml();else this.widget.on("click",n.proxy(this.click,this));setTimeout(n.proxy(this.initCounter,this),0)},update:function(t){n.extend(this.options,{forceUpdate:!1},t);this.widget.find("."+i+"__counter").remove();this.initCounter()},detectService:function(){var t=this.widget.data("service"),u,f,i,e;if(!t){for(u=this.widget[0],f=u.classList||u.className.split(" "),i=0;i<f.length;i++)if(e=f[i],r[e]){t=e;break}if(!t)return}this.service=t;n.extend(this.options,r[t])},detectParams:function(){var n=this.widget.data(),t;n.counter&&(t=parseInt(n.counter,10),isNaN(t)?this.options.counterUrl=n.counter:this.options.counterNumber=t);n.title&&(this.options.title=n.title);n.url&&(this.options.url=n.url)},initHtml:function(){var i=this.options,t=this.widget,e=t.find("a"),r,o,f;if(e.length&&this.cloneDataAttrs(e,t),r=n("<span>",{"class":this.getElementClassNames("button"),text:t.text()}),i.clickUrl)o=u(i.clickUrl,{url:i.url,title:i.title}),f=n("<a>",{href:o}),this.cloneDataAttrs(t,f),t.replaceWith(f),this.widget=t=f;else t.on("click",n.proxy(this.click,this));t.removeClass(this.service);t.addClass(this.getElementClassNames("widget"));r.prepend(n("<span>",{"class":this.getElementClassNames("icon")}));t.empty().append(r);this.button=r},initCounter:function(){if(this.options.counters)if(this.options.counterNumber)this.updateCounter(this.options.counterNumber);else{var t={counterUrl:this.options.counterUrl,forceUpdate:this.options.forceUpdate};o.fetch(this.service,this.options.url,t).always(n.proxy(this.updateCounter,this))}},cloneDataAttrs:function(n,t){var i=n.data();for(var r in i)i.hasOwnProperty(r)&&t.data(r,i[r])},getElementClassNames:function(n){return e(n,this.service)},updateCounter:function(t){var r,u;t=parseInt(t,10)||0;r={"class":this.getElementClassNames("counter"),text:t};t||this.options.zeroes||(r["class"]+=" "+i+"__counter_empty",r.text="");u=n("<span>",r);this.widget.append(u);this.widget.trigger("counter."+i,[this.service,t])},click:function(t){var i=this.options,f=!0,r;return n.isFunction(i.click)&&(f=i.click.call(this,t)),f&&(r=u(i.popupUrl,{url:i.url,title:i.title}),r=this.addAdditionalParamsToUrl(r),this.openPopup(r,{width:i.popupWidth,height:i.popupHeight})),!1},addAdditionalParamsToUrl:function(t){var i=n.param(n.extend(this.widget.data(),this.options.data)),r;return n.isEmptyObject(i)?t:(r=t.indexOf("?")===-1?"?":"&",t+r+i)},openPopup:function(t,r){var o=Math.round(screen.width/2-r.width/2),f=0,u,e;screen.height>r.height&&(f=Math.round(screen.height/3-r.height/2));u=window.open(t,"sl_"+this.service,"left="+o+",top="+f+",width="+r.width+",height="+r.height+",personalbar=0,toolbar=0,scrollbars=1,resizable=1");u?(u.focus(),this.widget.trigger("popup_opened."+i,[this.service,u]),e=setInterval(n.proxy(function(){u.closed&&(clearInterval(e),this.widget.trigger("popup_closed."+i,this.service))},this),this.options.popupCheckInterval)):location.href=t}};n(function(){n("."+i).socialLikes()})})